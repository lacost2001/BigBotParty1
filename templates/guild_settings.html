{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {{ guild.name }} - Discord Bot Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center mb-4">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            {% if guild.icon %}
            <img src="https://cdn.discordapp.com/icons/{{ guild.id }}/{{ guild.icon }}.png" 
                 alt="{{ guild.name }}" class="rounded me-3" width="48" height="48">
            {% endif %}
            <div>
                <h2 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ {{ guild.name }}</h2>
                <small class="text-muted">ID: {{ guild.id }}</small>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('update_guild_settings', guild_id=guild.id) }}">
    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>–†–æ–ª–∏</h5>
                    {% if settings.event_creator_role or settings.moderator_role or settings.ping_role %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ
                        </span>
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="event_creator_role" class="form-label">
                            –†–æ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏–π
                            {% if settings.event_creator_role %}
                                <i class="fas fa-check-circle text-success ms-1"></i>
                            {% endif %}
                        </label>
                        <select class="form-select {% if settings.event_creator_role %}border-success{% endif %}" 
                                id="event_creator_role" name="event_creator_role">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" 
                                {% if (settings.event_creator_role|default(0)|int) == (role.id|int) %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">–†–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è</div>
                    </div>

                    <div class="mb-3">
                        <label for="moderator_role" class="form-label">–†–æ–ª—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</label>
                        <select class="form-select" id="moderator_role" name="moderator_role">
                            <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" 
                                {% if (settings.moderator_role|default(0)|int) == (role.id|int) %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">–†–æ–ª—å —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
                    </div>

                    <div class="mb-3">
                        <label for="ping_role" class="form-label">–†–æ–ª—å –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</label>
                        <select class="form-select" id="ping_role" name="ping_role">
                            <option value="everyone" 
                                {% if settings.ping_role == "everyone" %}selected{% endif %}>
                                @everyone
                            </option>
                            {% for role in roles %}
                            <option value="{{ role.id }}" 
                                {% if settings.ping_role != 'everyone' and (settings.ping_role|int) == (role.id|int) %}selected{% endif %}>
                                {{ role.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">–ö–æ–≥–æ –ø–∏–Ω–≥–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hashtag me-2"></i>–ö–∞–Ω–∞–ª—ã</h5>
                    {% if settings.monitored_channels %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>{{ settings.monitored_channels|length }} –∫–∞–Ω–∞–ª–æ–≤
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-minus-circle me-1"></i>–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –∫–∞–Ω–∞–ª—ã</label>
                        <div style="max-height: 300px; overflow-y: auto;">
                            {# –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: –µ—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –∫–ª—é—á–∞ –Ω–µ—Ç, –ø–æ–¥—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ #}
                            {# –ë–µ–∑–æ–ø–∞—Å–Ω–æ: settings.monitored_channels –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –∏–∑ –¥–µ—Ñ–æ–ª—Ç–æ–≤ #}
                            {% for channel in channels %}
                            <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                        value="{{ channel.id }}" name="monitored_channels"
                        id="channel_{{ channel.id }}"
                        {% if (channel.id|int) in (settings.monitored_channels or []) or (channel.id|string) in (settings.monitored_channels or []) %}checked{% endif %}>
                                <label class="form-check-label" for="channel_{{ channel.id }}">
                                    # {{ channel.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="form-text">–ö–∞–Ω–∞–ª—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-toggle-on me-2"></i>–§—É–Ω–∫—Ü–∏–∏</h5>
                    {% set enabled_count = (settings.monitoring_enabled | default(false) | int) + (settings.cleanup_enabled | default(false) | int) + (settings.reminders_enabled | default(false) | int) %}
                    {% if enabled_count > 0 %}
                        <span class="badge bg-info">
                            <i class="fas fa-cog me-1"></i>{{ enabled_count }}/3 –∞–∫—Ç–∏–≤–Ω–æ
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-power-off me-1"></i>–û—Ç–∫–ª—é—á–µ–Ω–æ
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="monitoring_enabled" name="monitoring_enabled"
                                       {% if settings.monitoring_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="monitoring_enabled">
                                    <strong>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤</strong>
                                </label>
                                <div class="form-text">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –∫–∞–Ω–∞–ª–∞—Ö</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="cleanup_enabled" name="cleanup_enabled"
                                       {% if settings.cleanup_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="cleanup_enabled">
                                    <strong>–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞</strong>
                                </label>
                                <div class="form-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="reminders_enabled" name="reminders_enabled"
                                       {% if settings.reminders_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="reminders_enabled">
                                    <strong>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</strong>
                                </label>
                                <div class="form-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–±—ã—Ç–∏–µ–º</div>
                            </div>
                            <div class="mt-2">
                                <label for="reminder_time" class="form-label">–ó–∞ —Å–∫–æ–ª—å–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å</label>
                    <input type="time" class="form-control" id="reminder_time" name="reminder_time" 
                        value="{{ '%02d:%02d'|format((settings.reminder_time|default([0,15]))[0]|int, (settings.reminder_time|default([0,15]))[1]|int) }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recruit Bot Settings -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥–∞ –∏ –æ—á–∫–æ–≤</h5>
                    {% set recruit_configured = settings.recruit_settings and (settings.recruit_settings.default_role or settings.recruit_settings.recruit_role) %}
                    {% if recruit_configured %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>–ù–∞—Å—Ç—Ä–æ–µ–Ω–æ
                        </span>
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–æ–ª–∏</h6>
                            
                            <div class="mb-3">
                                <label for="recruit_default_role" class="form-label">–†–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                                <select class="form-select" id="recruit_default_role" name="recruit_default_role">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.default_role|default(0)|int) == (role.id|int) %}selected{% endif %}>
                                        {{ role.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–†–æ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º —á–ª–µ–Ω–∞–º</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_recruit_role" class="form-label">–†–æ–ª—å —Ä–µ–∫—Ä—É—Ç–∞</label>
                                <select class="form-select" id="recruit_recruit_role" name="recruit_recruit_role">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for role in roles %}
                                    <option value="{{ role.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.recruit_role|default(0)|int) == (role.id|int) %}selected{% endif %}>
                                        {{ role.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–†–æ–ª—å –¥–ª—è —Ä–µ–∫—Ä—É—Ç–æ–≤</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_guild_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∏–ª—å–¥–∏–∏ –≤ Albion</label>
                                <input type="text" class="form-control" id="recruit_guild_name" name="recruit_guild_name" 
                                       value="{{ settings.recruit_settings.guild_name|default('') }}" 
                                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π –≥–∏–ª—å–¥–∏–∏ –≤ Albion Online">
                                <div class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∏–ª—å–¥–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ –≤ Albion Online</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_cooldown_hours" class="form-label">–ö—É–ª–¥–∞—É–Ω –∑–∞—è–≤–æ–∫ (—á–∞—Å—ã)</label>
                                <input type="number" class="form-control" id="recruit_cooldown_hours" name="recruit_cooldown_hours" 
                                       value="{{ settings.recruit_settings.cooldown_hours|default(1) }}" 
                                       min="0" max="168">
                                <div class="form-text">–í—Ä–µ–º—è –º–µ–∂–¥—É –∑–∞—è–≤–∫–∞–º–∏ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (0 = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –∏ –∫–∞–Ω–∞–ª—ã</h6>
                            
                            <div class="mb-3">
                                <label for="recruit_moderator_roles" class="form-label">–†–æ–ª–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ—á–∫–æ–≤</label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.375rem;">
                                    {% set selected_moderator_roles = settings.recruit_settings.points_moderator_roles.split(',') if settings.recruit_settings and settings.recruit_settings.points_moderator_roles else [] %}
                                    {% for role in roles %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               value="{{ role.id }}" name="recruit_moderator_roles"
                                               id="mod_role_{{ role.id }}"
                                               {% if (role.id|string) in selected_moderator_roles %}checked{% endif %}>
                                        <label class="form-check-label" for="mod_role_{{ role.id }}">
                                            {{ role.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text">–†–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ–¥–æ–±—Ä—è—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ –æ—á–∫–∏</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_recruiter_roles" class="form-label">–†–æ–ª–∏ —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤</label>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.375rem;">
                                    {% set selected_recruiter_roles = settings.recruit_settings.recruiter_roles.split(',') if settings.recruit_settings and settings.recruit_settings.recruiter_roles else [] %}
                                    {% for role in roles %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               value="{{ role.id }}" name="recruit_recruiter_roles"
                                               id="recruiter_role_{{ role.id }}"
                                               {% if (role.id|string) in selected_recruiter_roles %}checked{% endif %}>
                                        <label class="form-check-label" for="recruiter_role_{{ role.id }}">
                                            {{ role.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="form-text">–†–æ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ —Ä–µ–∫—Ä—É—Ç–æ–≤</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_events_channel" class="form-label">–ö–∞–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</label>
                                <select class="form-select" id="recruit_events_channel" name="recruit_events_channel">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for channel in channels %}
                                    <option value="{{ channel.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.events_channel|default(0)|int) == (channel.id|int) %}selected{% endif %}>
                                        # {{ channel.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–ö–∞–Ω–∞–ª –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Å–æ–±—ã—Ç–∏—è</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_shop_channel" class="form-label">–ö–∞–Ω–∞–ª –º–∞–≥–∞–∑–∏–Ω–∞</label>
                                <select class="form-select" id="recruit_shop_channel" name="recruit_shop_channel">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for channel in channels %}
                                    <option value="{{ channel.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.shop_channel|default(0)|int) == (channel.id|int) %}selected{% endif %}>
                                        # {{ channel.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–ö–∞–Ω–∞–ª –¥–ª—è –ø–æ–∫—É–ø–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_forum_channel" class="form-label">–ö–∞–Ω–∞–ª-—Ñ–æ—Ä—É–º –∑–∞—è–≤–æ–∫ –≤ –≥–∏–ª—å–¥–∏—é</label>
                                <select class="form-select" id="recruit_forum_channel" name="recruit_forum_channel">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for channel in forum_channels %}
                                    <option value="{{ channel.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.forum_channel|default(0)|int) == (channel.id|int) %}selected{% endif %}>
                                        üìã {{ channel.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–§–æ—Ä—É–º –≥–¥–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥–∏–ª—å–¥–∏—é</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_points_panel_channel" class="form-label">–ö–∞–Ω–∞–ª –ø–∞–Ω–µ–ª–∏ –æ—á–∫–æ–≤</label>
                                <select class="form-select" id="recruit_points_panel_channel" name="recruit_points_panel_channel">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for channel in channels %}
                                    <option value="{{ channel.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.points_panel_channel|default(0)|int) == (channel.id|int) %}selected{% endif %}>
                                        # {{ channel.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–ö–∞–Ω–∞–ª –≥–¥–µ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –ø–∞–Ω–µ–ª—å –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –æ—á–∫–∏</div>
                            </div>

                            <div class="mb-3">
                                <label for="recruit_recruit_panel_channel" class="form-label">–ö–∞–Ω–∞–ª –ø–∞–Ω–µ–ª–∏ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥–∞</label>
                                <select class="form-select" id="recruit_recruit_panel_channel" name="recruit_recruit_panel_channel">
                                    <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω–æ</option>
                                    {% for channel in channels %}
                                    <option value="{{ channel.id }}" 
                                        {% if settings.recruit_settings and (settings.recruit_settings.recruit_panel_channel|default(0)|int) == (channel.id|int) %}selected{% endif %}>
                                        # {{ channel.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">–ö–∞–Ω–∞–ª –≥–¥–µ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –≤ –≥–∏–ª—å–¥–∏—é</div>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π -->
                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–µ–π</h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª—è–º–∏:</strong> –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö.
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-plus fa-2x text-primary mb-2"></i>
                                            <h6 class="card-title">–ü–∞–Ω–µ–ª—å –Ω–∞–±–æ—Ä–∞</h6>
                                            <p class="card-text small">–ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–∏–µ–º –≤ –≥–∏–ª—å–¥–∏—é</p>
                                            <button type="button" class="btn btn-primary btn-sm" onclick="deployPanel('recruit')" 
                                                    {% if not settings.recruit_settings or not settings.recruit_settings.recruit_panel_channel %}disabled{% endif %}>
                                                <i class="fas fa-rocket me-1"></i>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                            </button>
                                            {% if not settings.recruit_settings or not settings.recruit_settings.recruit_panel_channel %}
                                            <div class="text-muted small mt-1">–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <i class="fas fa-star fa-2x text-warning mb-2"></i>
                                            <h6 class="card-title">–ü–∞–Ω–µ–ª—å –æ—á–∫–æ–≤</h6>
                                            <p class="card-text small">–ö–Ω–æ–ø–∫–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–¥–∞—á—É –æ—á–∫–æ–≤</p>
                                            <button type="button" class="btn btn-warning btn-sm" onclick="deployPanel('points')" 
                                                    {% if not settings.recruit_settings or not settings.recruit_settings.points_panel_channel %}disabled{% endif %}>
                                                <i class="fas fa-rocket me-1"></i>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                            </button>
                                            {% if not settings.recruit_settings or not settings.recruit_settings.points_panel_channel %}
                                            <div class="text-muted small mt-1">–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <i class="fas fa-layer-group fa-2x text-success mb-2"></i>
                                            <h6 class="card-title">–û–±–µ –ø–∞–Ω–µ–ª–∏</h6>
                                            <p class="card-text small">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø–∞–Ω–µ–ª—å –Ω–∞–±–æ—Ä–∞ –∏ –æ—á–∫–æ–≤</p>
                                            <button type="button" class="btn btn-success btn-sm" onclick="deployPanel('both')" 
                                                    {% if not settings.recruit_settings or (not settings.recruit_settings.recruit_panel_channel and not settings.recruit_settings.points_panel_channel) %}disabled{% endif %}>
                                                <i class="fas fa-rocket me-1"></i>–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ
                                            </button>
                                            {% if not settings.recruit_settings or (not settings.recruit_settings.recruit_panel_channel and not settings.recruit_settings.points_panel_channel) %}
                                            <div class="text-muted small mt-1">–ö–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-muted mb-3">–ü–µ—Ä–∏–æ–¥ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="recruit_points_start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                        <input type="date" class="form-control" id="recruit_points_start_date" name="recruit_points_start_date" 
                                               value="{{ settings.recruit_settings.points_start_date|default('') }}">
                                        <div class="form-text">–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="recruit_points_end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                        <input type="date" class="form-control" id="recruit_points_end_date" name="recruit_points_end_date" 
                                               value="{{ settings.recruit_settings.points_end_date|default('') }}">
                                        <div class="form-text">–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-times me-2"></i>–û—Ç–º–µ–Ω–∞
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                </button>
            </div>
        </div>
    </div>
</form>

<script>
async function deployPanel(panelType) {
    const guildId = '{{ guild.id }}';
    const button = event.target;
    const originalText = button.innerHTML;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–†–∞–∑–º–µ—â–µ–Ω–∏–µ...';
    
    try {
        const response = await fetch(`/api/guild/${guildId}/deploy-panels`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                panel_type: panelType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // –£—Å–ø–µ—Ö
            button.className = button.className.replace(/btn-\w+/, 'btn-success');
            button.innerHTML = '<i class="fas fa-check me-1"></i>–†–∞–∑–º–µ—â–µ–Ω–æ!';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(result.message || '–ü–∞–Ω–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω—ã!', 'success');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                button.className = button.className.replace('btn-success', getOriginalButtonClass(panelType));
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        } else {
            // –û—à–∏–±–∫–∞
            button.className = button.className.replace(/btn-\w+/, 'btn-danger');
            button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>–û—à–∏–±–∫–∞';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            showNotification(result.message || '–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π', 'error');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                button.className = button.className.replace('btn-danger', getOriginalButtonClass(panelType));
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –ø–∞–Ω–µ–ª–∏:', error);
        
        button.className = button.className.replace(/btn-\w+/, 'btn-danger');
        button.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>–û—à–∏–±–∫–∞';
        
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        
        setTimeout(() => {
            button.className = button.className.replace('btn-danger', getOriginalButtonClass(panelType));
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    }
}

function getOriginalButtonClass(panelType) {
    switch (panelType) {
        case 'recruit': return 'btn-primary';
        case 'points': return 'btn-warning';
        case 'both': return 'btn-success';
        default: return 'btn-primary';
    }
}

function showNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>

{% endblock %}
