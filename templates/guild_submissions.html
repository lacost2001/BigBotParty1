{% extends "base.html" %}

{% block title %}Управление заявками - {{ guild_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-inbox me-2 text-primary"></i>
                    Управление заявками
                </h2>
                <small class="text-muted">{{ guild_name }}</small>
            </div>
            <div>
                <a href="{{ url_for('guild_settings', guild_id=guild_id) }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Назад
                </a>
                <button class="btn btn-primary" onclick="refreshActiveTab()">
                    <i class="fas fa-sync me-2"></i>Обновить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Вкладки -->
<div class="row mb-4">
    <div class="col-12">
        <ul class="nav nav-tabs" id="submissionTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="points-tab" data-bs-toggle="tab" data-bs-target="#points" type="button" role="tab" onclick="switchTab('points')">
                    <i class="fas fa-coins me-2"></i>Заявки на очки
                    <span class="badge bg-primary ms-2" id="pointsTabBadge">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="guild-tab" data-bs-toggle="tab" data-bs-target="#guild" type="button" role="tab" onclick="switchTab('guild')">
                    <i class="fas fa-users me-2"></i>Заявки в гильдию
                    <span class="badge bg-warning ms-2" id="guildTabBadge">0</span>
                </button>
            </li>
        </ul>
    </div>
</div>

<div class="tab-content" id="submissionTabContent">
    <!-- Вкладка: Заявки на очки -->
    <div class="tab-pane fade show active" id="points" role="tabpanel">
        <!-- Статистика заявок на очки -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-warning bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                        <h4 class="mb-0" id="pointsPendingCount">-</h4>
                        <small>Ожидающих</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-success bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-check fa-2x mb-2"></i>
                        <h4 class="mb-0" id="pointsApprovedCount">-</h4>
                        <small>Одобрено</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-danger bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-times fa-2x mb-2"></i>
                        <h4 class="mb-0" id="pointsRejectedCount">-</h4>
                        <small>Отклонено</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h4 class="mb-0" id="pointsTotalCount">-</h4>
                        <small>Всего заявок</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры для заявок на очки -->
        <div class="row mb-3">
            <div class="col-md-6">
                <select class="form-select" id="pointsStatusFilter" onchange="filterPointsSubmissions()">
                    <option value="">Все статусы</option>
                    <option value="pending">Ожидающие</option>
                    <option value="approved">Одобренные</option>
                    <option value="rejected">Отклонённые</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" id="pointsSearchInput" placeholder="Поиск по описанию..." onkeyup="filterPointsSubmissions()">
            </div>
        </div>

        <!-- Таблица заявок на очки -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-coins me-2"></i>
                    Заявки на очки
                </h5>
            </div>
            <div class="card-body">
                <div id="pointsSubmissionsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка заявок на очки...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Вкладка: Заявки в гильдию -->
    <div class="tab-pane fade" id="guild" role="tabpanel">
        <!-- Статистика заявок в гильдию -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-warning bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                        <h4 class="mb-0" id="guildPendingCount">-</h4>
                        <small>На рассмотрении</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-success bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-user-plus fa-2x mb-2"></i>
                        <h4 class="mb-0" id="guildAcceptedCount">-</h4>
                        <small>Приняты</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-danger bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-user-times fa-2x mb-2"></i>
                        <h4 class="mb-0" id="guildRejectedCount">-</h4>
                        <small>Отклонены</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info bg-gradient">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h4 class="mb-0" id="guildTotalCount">-</h4>
                        <small>Всего заявок</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Фильтры для заявок в гильдию -->
        <div class="row mb-3">
            <div class="col-md-6">
                <select class="form-select" id="guildStatusFilter" onchange="filterGuildApplications()">
                    <option value="">Все статусы</option>
                    <option value="pending">На рассмотрении</option>
                    <option value="accepted">Приняты</option>
                    <option value="rejected">Отклонены</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" id="guildSearchInput" placeholder="Поиск по имени игрока..." onkeyup="filterGuildApplications()">
            </div>
        </div>

        <!-- Таблица заявок в гильдию -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Заявки на вступление в гильдию
                </h5>
            </div>
            <div class="card-body">
                <div id="guildApplicationsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка заявок в гильдию...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра деталей заявки -->
<div class="modal fade" id="submissionDetailsModal" tabindex="-1" aria-labelledby="submissionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submissionDetailsModalLabel">Детали заявки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Основная информация</h6>
                        <p><strong>ID:</strong> <span id="detailId">-</span></p>
                        <p><strong>Игрок:</strong> <span id="detailPlayer">-</span></p>
                        <p><strong>Дата:</strong> <span id="detailDate">-</span></p>
                        <p><strong>Статус:</strong> <span id="detailStatus" class="badge">-</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Детали события</h6>
                        <p><strong>Событие:</strong> <span id="detailEvent">-</span></p>
                        <p><strong>Действие:</strong> <span id="detailAction">-</span></p>
                        <p><strong>Группа:</strong> <span id="detailGroup">-</span></p>
                        <p><strong>Очки:</strong> <span id="detailPoints">-</span></p>
                    </div>
                </div>
                <div class="row mt-3" id="descriptionSection">
                    <div class="col-12">
                        <h6>Описание события</h6>
                        <p id="detailDescription" class="text-muted">-</p>
                    </div>
                </div>
                <div class="row mt-3" id="participantsSection">
                    <div class="col-12">
                        <h6>Участники события</h6>
                        <div id="detailParticipants" class="d-flex flex-wrap gap-2">
                            <span class="text-muted">Загрузка...</span>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="screenshotSection" style="display: none;">
                    <div class="col-12">
                        <h6>Скриншот</h6>
                        <div class="text-center">
                            <img id="detailScreenshot" src="" alt="Скриншот события" class="img-fluid" style="max-height: 300px; cursor: pointer;" onclick="openScreenshotModal(this.src)">
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="reviewSection" style="display: none;">
                    <div class="col-12">
                        <h6>Информация о рассмотрении</h6>
                        <p><strong>Рассмотрел:</strong> <span id="detailReviewer">-</span></p>
                        <p><strong>Дата рассмотрения:</strong> <span id="detailReviewDate">-</span></p>
                        <p><strong>Комментарий:</strong> <span id="detailComment">-</span></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <div id="modalActions" class="d-none">
                    <button type="button" class="btn btn-success me-2" onclick="approveSubmissionFromModal()">Одобрить</button>
                    <button type="button" class="btn btn-danger" onclick="rejectSubmissionFromModal()">Отклонить</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для полноэкранного просмотра скриншота -->
<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalLabel">Скриншот события</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="fullScreenshot" src="" alt="Скриншот события" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<script>
let currentTab = 'points'; // Текущая активная вкладка
let pointsSubmissions = []; // Заявки на очки
let guildApplications = []; // Заявки в гильдию (пока пустой массив)

// Переключение вкладок
function switchTab(tab) {
    currentTab = tab;
    
    if (tab === 'points') {
        loadPointsSubmissions();
    } else if (tab === 'guild') {
        loadGuildApplications();
    }
}

// Обновление активной вкладки
function refreshActiveTab() {
    switchTab(currentTab);
}

// Загрузка заявок на очки
async function loadPointsSubmissions() {
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/all`);
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('pointsSubmissionsList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка загрузки: ${data.error}
                </div>
            `;
            return;
        }
        
        pointsSubmissions = data.submissions || [];
        await displayPointsSubmissions(pointsSubmissions);
        updatePointsStatistics(pointsSubmissions);
        
    } catch (error) {
        console.error('Ошибка при загрузке заявок на очки:', error);
        document.getElementById('pointsSubmissionsList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Ошибка загрузки заявок: ${error.message}
            </div>
        `;
    }
}

// Загрузка заявок в гильдию (пока заглушка)
async function loadGuildApplications() {
    // Пока что показываем заглушку
    guildApplications = [];
    displayGuildApplications(guildApplications);
    updateGuildStatistics(guildApplications);
}

// Отображение заявок на очки
async function displayPointsSubmissions(submissions) {
    const container = document.getElementById('pointsSubmissionsList');
    
    if (!submissions || submissions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h5>Нет заявок на очки</h5>
                <p>Заявки на события и очки будут отображаться здесь</p>
            </div>
        `;
        return;
    }
    
    // Собираем все уникальные ID пользователей
    const userIds = [...new Set(submissions.map(s => s.submitter_id))];
    
    // Загружаем имена пользователей
    let userNames = {};
    try {
        const response = await fetch(`/api/{{ guild_id }}/users/names`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_ids: userIds
            })
        });
        
        const data = await response.json();
        if (data.success && data.users) {
            data.users.forEach(user => {
                userNames[user.id] = user.display_name || user.username;
            });
        }
    } catch (error) {
        console.error('Ошибка при загрузке имен пользователей:', error);
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Игрок</th>
                        <th>Событие</th>
                        <th>Действие</th>
                        <th>Группа</th>
                        <th>Очки</th>
                        <th>Статус</th>
                        <th>Дата</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    submissions.forEach(submission => {
        const statusBadge = getStatusBadge(submission.status);
        const createdDate = new Date(submission.created_at).toLocaleDateString('ru-RU');
        const playerName = userNames[submission.submitter_id] || `<@${submission.submitter_id}>`;
        
        html += `
            <tr>
                <td>#${submission.id}</td>
                <td><span class="badge bg-info">${playerName}</span></td>
                <td><span class="badge bg-secondary">${submission.event_type}</span></td>
                <td><span class="badge bg-info">${submission.action}</span></td>
                <td>${submission.group_size}</td>
                <td>${submission.base_points}</td>
                <td>${statusBadge}</td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSubmissionDetails(${submission.id})" title="Посмотреть детали">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${submission.status === 'pending' ? `
                        <button class="btn btn-sm btn-success me-1" onclick="approvePointsSubmission(${submission.id})" title="Одобрить">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectPointsSubmission(${submission.id})" title="Отклонить">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Отображение заявок в гильдию
function displayGuildApplications(applications) {
    const container = document.getElementById('guildApplicationsList');
    
    container.innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-users fa-3x mb-3"></i>
            <h5>Система заявок в гильдию</h5>
            <p>Функционал заявок на вступление в гильдию будет добавлен в следующем обновлении</p>
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                Здесь будут отображаться заявки игроков на вступление в гильдию
            </div>
        </div>
    `;
}

// Обновление статистики заявок на очки
function updatePointsStatistics(submissions) {
    const pending = submissions.filter(s => s.status === 'pending').length;
    const approved = submissions.filter(s => s.status === 'approved').length;
    const rejected = submissions.filter(s => s.status === 'rejected').length;
    const total = submissions.length;
    
    document.getElementById('pointsPendingCount').textContent = pending;
    document.getElementById('pointsApprovedCount').textContent = approved;
    document.getElementById('pointsRejectedCount').textContent = rejected;
    document.getElementById('pointsTotalCount').textContent = total;
    document.getElementById('pointsTabBadge').textContent = pending;
}

// Обновление статистики заявок в гильдию
function updateGuildStatistics(applications) {
    document.getElementById('guildPendingCount').textContent = '0';
    document.getElementById('guildAcceptedCount').textContent = '0';
    document.getElementById('guildRejectedCount').textContent = '0';
    document.getElementById('guildTotalCount').textContent = '0';
    document.getElementById('guildTabBadge').textContent = '0';
}

// Фильтрация заявок на очки
async function filterPointsSubmissions() {
    const statusFilter = document.getElementById('pointsStatusFilter').value;
    const searchText = document.getElementById('pointsSearchInput').value.toLowerCase();
    
    let filtered = pointsSubmissions;
    
    if (statusFilter) {
        filtered = filtered.filter(s => s.status === statusFilter);
    }
    
    if (searchText) {
        filtered = filtered.filter(s => 
            s.description?.toLowerCase().includes(searchText) ||
            s.event_type.toLowerCase().includes(searchText) ||
            s.action.toLowerCase().includes(searchText)
        );
    }
    
    await displayPointsSubmissions(filtered);
}

// Фильтрация заявок в гильдию
function filterGuildApplications() {
    // Пока заглушка
    displayGuildApplications([]);
}

// Получение бейджа статуса
function getStatusBadge(status) {
    switch (status) {
        case 'pending':
            return '<span class="badge bg-warning">Ожидает</span>';
        case 'approved':
            return '<span class="badge bg-success">Одобрена</span>';
        case 'rejected':
            return '<span class="badge bg-danger">Отклонена</span>';
        default:
            return '<span class="badge bg-secondary">Неизвестно</span>';
    }
}

// Одобрение заявки на очки
async function approvePointsSubmission(submissionId) {
    const multiplier = prompt('Введите множитель очков (по умолчанию 1.0):', '1.0');
    if (multiplier === null) return;
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_id: submissionId,
                multiplier: parseFloat(multiplier) || 1.0
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadPointsSubmissions(); // Перезагружаем список
        } else {
            alert('Ошибка при одобрении заявки: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка при одобрении заявки:', error);
        alert('Ошибка при одобрении заявки: ' + error.message);
    }
}

// Отклонение заявки на очки
async function rejectPointsSubmission(submissionId) {
    const reason = prompt('Введите причину отклонения (необязательно):');
    if (reason === null) return;
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_id: submissionId,
                reason: reason || ''
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadPointsSubmissions(); // Перезагружаем список
        } else {
            alert('Ошибка при отклонении заявки: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка при отклонении заявки:', error);
        alert('Ошибка при отклонении заявки: ' + error.message);
    }
}

// Просмотр деталей заявки
let currentSubmissionDetails = null;

async function viewSubmissionDetails(submissionId) {
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/${submissionId}`);
        const data = await response.json();
        
        if (data.success) {
            currentSubmissionDetails = data.submission;
            populateSubmissionModal(data.submission);
            
            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('submissionDetailsModal'));
            modal.show();
        } else {
            alert('Ошибка при загрузке деталей заявки: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка при загрузке деталей заявки:', error);
        alert('Ошибка при загрузке деталей заявки: ' + error.message);
    }
}

function populateSubmissionModal(submission) {
    // Основная информация
    document.getElementById('detailId').textContent = `#${submission.id}`;
    
    // Загружаем имя игрока, который подал заявку
    loadSubmitterName(submission.submitter_id);
    
    document.getElementById('detailDate').textContent = new Date(submission.created_at).toLocaleString('ru-RU');
    
    const statusBadge = getStatusBadge(submission.status);
    document.getElementById('detailStatus').innerHTML = statusBadge.replace('<span', '<span').replace('</span>', '</span>');
    
    // Детали события
    document.getElementById('detailEvent').textContent = submission.event_type || '-';
    document.getElementById('detailAction').textContent = submission.action || '-';
    document.getElementById('detailGroup').textContent = submission.group_size || '-';
    document.getElementById('detailPoints').textContent = submission.base_points || '-';
    
    // Описание события
    const descriptionEl = document.getElementById('detailDescription');
    if (submission.description && submission.description.trim()) {
        descriptionEl.textContent = submission.description;
        descriptionEl.className = '';
    } else {
        descriptionEl.textContent = 'Описание не указано';
        descriptionEl.className = 'text-muted';
    }
    
    // Участники события
    const participantsEl = document.getElementById('detailParticipants');
    if (submission.participant_ids && submission.participant_ids.length > 0) {
        loadParticipantNames(submission.participant_ids);
    } else {
        participantsEl.innerHTML = '<span class="text-muted">Нет участников</span>';
    }
    
    // Скриншот
    const screenshotSection = document.getElementById('screenshotSection');
    const screenshotEl = document.getElementById('detailScreenshot');
    if (submission.screenshot_url && submission.screenshot_url.trim()) {
        screenshotEl.src = submission.screenshot_url;
        screenshotSection.style.display = 'block';
    } else {
        screenshotSection.style.display = 'none';
    }
    
    // Информация о рассмотрении
    const reviewSection = document.getElementById('reviewSection');
    const modalActions = document.getElementById('modalActions');
    
    if (submission.status !== 'pending') {
        // Показываем информацию о рассмотрении
        reviewSection.style.display = 'block';
        
        // Загружаем имя рассматривающего
        if (submission.reviewer_id) {
            loadReviewerName(submission.reviewer_id);
        } else {
            document.getElementById('detailReviewer').textContent = '-';
        }
        
        document.getElementById('detailReviewDate').textContent = submission.reviewed_at ? 
            new Date(submission.reviewed_at).toLocaleString('ru-RU') : '-';
        document.getElementById('detailComment').textContent = submission.comment || 'Без комментария';
        
        modalActions.classList.add('d-none');
    } else {
        // Скрываем информацию о рассмотрении для ожидающих заявок
        reviewSection.style.display = 'none';
        modalActions.classList.remove('d-none');
    }
}

// Загрузка имени игрока, который подал заявку
async function loadSubmitterName(submitterId) {
    const playerEl = document.getElementById('detailPlayer');
    playerEl.innerHTML = '<span class="text-muted">Загрузка...</span>';
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/users/names`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_ids: [submitterId]
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.users && data.users.length > 0) {
            const user = data.users[0];
            playerEl.innerHTML = `<span class="badge bg-info">${user.display_name || user.username}</span>`;
        } else {
            playerEl.innerHTML = `<span class="badge bg-secondary"><@${submitterId}></span>`;
        }
    } catch (error) {
        console.error('Ошибка при загрузке имени подавшего заявку:', error);
        playerEl.innerHTML = `<span class="badge bg-secondary"><@${submitterId}></span>`;
    }
}

// Загрузка имени рассматривающего
async function loadReviewerName(reviewerId) {
    const reviewerEl = document.getElementById('detailReviewer');
    reviewerEl.innerHTML = '<span class="text-muted">Загрузка...</span>';
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/users/names`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_ids: [reviewerId]
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.users && data.users.length > 0) {
            const user = data.users[0];
            reviewerEl.innerHTML = `<span class="badge bg-success">${user.display_name || user.username}</span>`;
        } else {
            reviewerEl.innerHTML = `<span class="badge bg-secondary"><@${reviewerId}></span>`;
        }
    } catch (error) {
        console.error('Ошибка при загрузке имени рассматривающего:', error);
        reviewerEl.innerHTML = `<span class="badge bg-secondary"><@${reviewerId}></span>`;
    }
}

// Загрузка имен участников
async function loadParticipantNames(participantIds) {
    const participantsEl = document.getElementById('detailParticipants');
    participantsEl.innerHTML = '<span class="text-muted">Загрузка имен...</span>';
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/users/names`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_ids: participantIds
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.users) {
            let html = '';
            data.users.forEach(user => {
                html += `<span class="badge bg-primary me-1 mb-1">${user.display_name || user.username}</span>`;
            });
            participantsEl.innerHTML = html || '<span class="text-muted">Нет участников</span>';
        } else {
            // Fallback к Discord ID если API недоступен
            let html = '';
            participantIds.forEach(id => {
                html += `<span class="badge bg-secondary me-1 mb-1"><@${id}></span>`;
            });
            participantsEl.innerHTML = html;
        }
    } catch (error) {
        console.error('Ошибка при загрузке имен участников:', error);
        // Fallback к Discord ID
        let html = '';
        participantIds.forEach(id => {
            html += `<span class="badge bg-secondary me-1 mb-1"><@${id}></span>`;
        });
        participantsEl.innerHTML = html;
    }
}

// Открытие скриншота в полном размере
function openScreenshotModal(imageUrl) {
    document.getElementById('fullScreenshot').src = imageUrl;
    const modal = new bootstrap.Modal(document.getElementById('screenshotModal'));
    modal.show();
}

async function approveSubmissionFromModal() {
    if (!currentSubmissionDetails) return;
    
    const multiplier = prompt('Введите множитель очков (по умолчанию 1.0):', '1.0');
    if (multiplier === null) return;
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_id: currentSubmissionDetails.id,
                multiplier: parseFloat(multiplier) || 1.0
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('submissionDetailsModal'));
            modal.hide();
            
            // Перезагружаем список
            loadPointsSubmissions();
        } else {
            alert('Ошибка при одобрении заявки: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка при одобрении заявки:', error);
        alert('Ошибка при одобрении заявки: ' + error.message);
    }
}

async function rejectSubmissionFromModal() {
    if (!currentSubmissionDetails) return;
    
    const reason = prompt('Введите причину отклонения (необязательно):');
    
    try {
        const response = await fetch(`/api/{{ guild_id }}/submissions/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_id: currentSubmissionDetails.id,
                reason: reason || ''
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('submissionDetailsModal'));
            modal.hide();
            
            // Перезагружаем список
            loadPointsSubmissions();
        } else {
            alert('Ошибка при отклонении заявки: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка при отклонении заявки:', error);
        alert('Ошибка при отклонении заявки: ' + error.message);
    }
}

// Загрузка при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadPointsSubmissions(); // По умолчанию загружаем заявки на очки
});

// Автообновление каждые 30 секунд
setInterval(() => {
    if (currentTab === 'points') {
        loadPointsSubmissions();
    } else if (currentTab === 'guild') {
        loadGuildApplications();
    }
}, 30000);
</script>
{% endblock %}
