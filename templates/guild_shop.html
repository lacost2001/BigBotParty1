{% extends "base.html" %}

{% block title %}Магазин очков - {{ guild_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-shopping-cart me-2 text-success"></i>
                    Магазин очков
                </h2>
                <small class="text-muted">{{ guild_name }}</small>
            </div>
            <div>
                <a href="{{ url_for('guild_settings', guild_id=guild_id) }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Назад
                </a>
                <button class="btn btn-primary" onclick="loadPendingPurchases()">
                    <i class="fas fa-sync me-2"></i>Обновить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Статистика магазина -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-warning bg-gradient">
            <div class="card-body text-center">
                <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                <h4 class="mb-0" id="pendingPurchases">-</h4>
                <small>Ожидающих покупок</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success bg-gradient">
            <div class="card-body text-center">
                <i class="fas fa-check fa-2x mb-2"></i>
                <h4 class="mb-0" id="completedToday">-</h4>
                <small>Выдано сегодня</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info bg-gradient">
            <div class="card-body text-center">
                <i class="fas fa-coins fa-2x mb-2"></i>
                <h4 class="mb-0" id="totalSpent">-</h4>
                <small>Потрачено очков</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-primary bg-gradient">
            <div class="card-body text-center">
                <i class="fas fa-trophy fa-2x mb-2"></i>
                <h4 class="mb-0" id="topSpender">-</h4>
                <small>Топ покупатель</small>
            </div>
        </div>
    </div>
</div>

<!-- Ожидающие покупки -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Ожидающие покупки
                </h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="filterStatus" onchange="filterPurchases()">
                        <option value="pending">Ожидающие</option>
                        <option value="completed">Завершенные</option>
                        <option value="cancelled">Отмененные</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="purchasesTable">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Загрузка покупок...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Топ покупатели -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-medal me-2"></i>
                    Топ покупатели
                </h5>
            </div>
            <div class="card-body">
                <div id="topBuyers">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i>
                        Загрузка...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Популярные товары
                </h5>
            </div>
            <div class="card-body">
                <div id="popularItems">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i>
                        Загрузка...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра деталей покупки -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart me-2"></i>
                    Детали покупки #<span id="modalPurchaseId"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Содержимое загружается динамически -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-danger" onclick="processPurchaseModal('reject')">
                        <i class="fas fa-times me-1"></i>Отклонить
                    </button>
                    <button type="button" class="btn btn-success" onclick="processPurchaseModal('approve')">
                        <i class="fas fa-check me-1"></i>Выдать
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const guildId = '{{ guild_id }}';
let currentPurchases = [];
let currentPurchaseId = null;

function loadPendingPurchases() {
    fetch(`/api/${guildId}/shop/pending`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            currentPurchases = data.pending || [];
            updateStats();
            renderPurchases();
        })
        .catch(error => {
            console.error('Error loading purchases:', error);
            document.getElementById('purchasesTable').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Ошибка загрузки покупок: ${error.message}
                </div>
            `;
        });
}

function updateStats() {
    document.getElementById('pendingPurchases').textContent = currentPurchases.length;
    
    // Подсчет общей стоимости
    const totalSpent = currentPurchases.reduce((sum, p) => sum + (p.price || 0), 0);
    document.getElementById('totalSpent').textContent = totalSpent;
    
    // Остальную статистику можно загрузить отдельными запросами
    document.getElementById('completedToday').textContent = '-';
    document.getElementById('topSpender').textContent = '-';
}

function renderPurchases() {
    const container = document.getElementById('purchasesTable');
    
    if (currentPurchases.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                <h5>Нет ожидающих покупок</h5>
                <p>Все покупки обработаны</p>
            </div>
        `;
        return;
    }

    const html = `
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Покупатель</th>
                        <th>Товар</th>
                        <th>Цена</th>
                        <th>Дата</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    ${currentPurchases.map(purchase => `
                        <tr>
                            <td><code>${purchase.id}</code></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-success rounded-circle d-flex align-items-center justify-content-center me-2">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    <code>${purchase.user_id}</code>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>${purchase.item_name || 'Unknown'}</strong>
                                    ${purchase.item_description ? `<br><small class="text-muted">${purchase.item_description}</small>` : ''}
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-coins me-1"></i>${purchase.price || 0}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    ${new Date(purchase.created_at).toLocaleString('ru-RU')}
                                </small>
                            </td>
                            <td>
                                <span class="badge bg-warning">Ожидает</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewPurchase(${purchase.id})" title="Просмотр">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-success" onclick="processPurchase(${purchase.id}, 'approve')" title="Выдать">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-danger" onclick="processPurchase(${purchase.id}, 'reject')" title="Отклонить">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function filterPurchases() {
    const filterStatus = document.getElementById('filterStatus').value;
    // Здесь можно добавить фильтрацию по статусу
    renderPurchases();
}

function viewPurchase(id) {
    const purchase = currentPurchases.find(p => p.id === id);
    if (!purchase) return;
    
    currentPurchaseId = id;
    document.getElementById('modalPurchaseId').textContent = id;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-info-circle me-2"></i>Информация о покупке</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID покупки:</strong></td><td>${purchase.id}</td></tr>
                    <tr><td><strong>Покупатель:</strong></td><td><code>${purchase.user_id}</code></td></tr>
                    <tr><td><strong>Товар:</strong></td><td>${purchase.item_name || 'Unknown'}</td></tr>
                    <tr><td><strong>Цена:</strong></td><td><span class="badge bg-warning text-dark">${purchase.price || 0} очков</span></td></tr>
                    <tr><td><strong>Дата покупки:</strong></td><td>${new Date(purchase.created_at).toLocaleString('ru-RU')}</td></tr>
                    <tr><td><strong>Статус:</strong></td><td><span class="badge bg-warning">Ожидает обработки</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-box me-2"></i>Описание товара</h6>
                <div class="bg-light p-3 rounded">
                    ${purchase.item_description || 'Описание товара отсутствует'}
                </div>
                
                <h6 class="mt-3"><i class="fas fa-sticky-note me-2"></i>Заметки покупателя</h6>
                <div class="bg-light p-3 rounded">
                    ${purchase.notes || 'Заметки отсутствуют'}
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-12">
                <h6><i class="fas fa-cogs me-2"></i>Действия администратора</h6>
                <div class="mb-3">
                    <label for="adminNotes" class="form-label">Заметки администратора</label>
                    <textarea class="form-control" id="adminNotes" rows="3" 
                              placeholder="Введите заметки или причину отклонения..."></textarea>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modalContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('purchaseModal')).show();
}

async function processPurchase(id, action) {
    const reason = action === 'reject' ? prompt('Причина отклонения:') : '';
    if (action === 'reject' && !reason) return;
    
    try {
        const response = await fetch(`/api/${guildId}/shop/process`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                purchase_id: id,
                action: action,
                reason: reason
            })
        });
        
        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Не удалось обработать покупку');
        }
        
        const actionText = action === 'approve' ? 'выдан' : 'отклонен';
        showNotification(`Товар ${actionText}`, 'success');
        loadPendingPurchases();
        
    } catch (error) {
        showNotification(`Ошибка: ${error.message}`, 'error');
    }
}

function processPurchaseModal(action) {
    if (currentPurchaseId) {
        const adminNotes = document.getElementById('adminNotes')?.value || '';
        
        if (action === 'reject' && !adminNotes) {
            alert('Пожалуйста, укажите причину отклонения в заметках');
            return;
        }
        
        bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
        
        fetch(`/api/${guildId}/shop/process`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                purchase_id: currentPurchaseId,
                action: action,
                reason: adminNotes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Не удалось обработать покупку');
            }
            
            const actionText = action === 'approve' ? 'выдан' : 'отклонен';
            showNotification(`Товар ${actionText}`, 'success');
            loadPendingPurchases();
        })
        .catch(error => {
            showNotification(`Ошибка: ${error.message}`, 'error');
        });
    }
}

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas ${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}

// Загружаем покупки при загрузке страницы
document.addEventListener('DOMContentLoaded', loadPendingPurchases);

// Автообновление каждые 30 секунд
setInterval(loadPendingPurchases, 30000);
</script>
{% endblock %}
